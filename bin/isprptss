#!/usr/bin/env raku

use Spreadsheet::XLSX;
use ISP::dsmadmc;
use Data::Dump::Tree;

my %ISPLC02-inc     = (
                        ISPLC02                     => 0,
                      );

my %JATSMPRD02-inc  = (
                        CTSPSDB01SV                 => 0,
                        JADBCGNPRD01-GISPRD1-TDP    => 0,
                        JADBCGNPRD01-GISRPRD1-TDP   => 0,
                        JGCOUNDBLB01WPV             => 0,
                        JGMTDB01LPV-TKCSPROD-TDP    => 0,
                        JGOHAWDB01PV                => 0,
                        JGOHAWDB02PV                => 0,
                        P590A1-ITRPPRD1-TDP         => 0,
                        P590A1-PDBX-TDP             => 0,
                        P590A1-STATPROD-TDP         => 0,
                        P590A1-TASPRD1-TDP          => 0,
                        P590A1-TTRPPROD-TDP         => 0,
                        P590A10-NBUSPRD1-TDP        => 0,
                        P590A10-TDBPRD3-TDP         => 0,
                        P595A13-OEMPROD-TDP         => 0,
                        P770A21-EFTPRD1-TDP         => 0,
                        P770A21-SBFTPRD1-TDP        => 0,
                        P770A21-WMTPRD1-TDP         => 0,
                        SMB_DCI_SQL_BACKUPS         => 0,
                      );

my %CATSMDEV01-inc  = (
                        CADBFAREDR21-SBFTPRD1-TDP   => 0,
                        P590B10-TDBQA2-TDP          => 0,
                        P590B10-TDBQA3-TDP          => 0,
                        CTMTDB01LQV-TKCSUAT-TDP     => 0,
                        CTMTDB01LQV-TKCSDEV-TDP     => 0,
                        CTMTDB01LQV-TKCSTRN-TDP     => 0,
                        CTMTDB01LQV-TKCSTST-TDP     => 0,
                        CTMTDB01LQV-TKCSSTG2-TDP    => 0,
                        CTMTDB01LQV-TKCSDEV2-TDP    => 0,
                        CTMTDB01LQV-TKCSSTG3-TDP    => 0,
                        CADBBUSDR10-NBUSPRD1-TDP    => 0,
                        CADBBUSDR10-TDBPRD3-TDP     => 0,
                        CADBFAREDR21-EFTPRD1-TDP    => 0,
                        CADBFAREDR21-WMTPRD1-TDP    => 0,
                        CADBFAREDEV01-EFTQA1-TDP    => 0,
                        CADBFAREQA1-SBFTQA1-TDP     => 0,
                        CADBFAREQA1-EFTQA1-TDP      => 0,
                        CADBFAREQA1-WMTQA1-TDP      => 0,
                        CADBFAREQA1-SBFTQA3-TDP     => 0,
                        CADBFAREDEV01-WMTPRD1-TDP   => 0,
                        CADBFAREDEV01-SBFTPRD1-TDP  => 0,
                        CADBFAREQA1-WMTQA3-TDP      => 0,
                        CADBFAREQA1-EFTQA3-TDP      => 0,
                        JGDBMEDICALDV               => 0,
                        NCS-DNS-CTF                 => 0,
                        CTNCSAPPPM1WDV              => 0,
                        CTCOUNDBLB01WPV             => 0,
                      );

my %P520TSMJGB-inc  = (
                        JGMTPDDBCAD1PV              => 0,
                        JGMTPDDBCAD2PV              => 0,
                        JGMTPDDBRMS1PV              => 0,
                        JGMTPDDBRMS2PV              => 0,
                        JGMTPDRDWCADPV              => 0,
                        JGMTPDRDWRMSPV              => 0,
                        RCTRESZYIPP                 => 0,
                        JGAPPWWW1PP                 => 0,
                        JGDBMEDICALPV               => 0,
                      );

my $isp-admin       = 'A028441';
my @isp-servers     = <ISPLC01 ISPLC02 JATSMPRD02 P520TSMJGB CATSMDEV01>;

my $outfile;
given $ = run(<uname -n>, :out).out.slurp.chomp {
    when 'L-707970' { $outfile = '/mnt/c/Users/E028441/Downloads/IBM/ISP/Reporting/ISP Reporting.xlsx';   }
    when 'W-608863' { $outfile = '/mnt/d/Downloads/ISP/Reporting/ISP Reporting.xlsx';                 }
    default         { die;                                                                      }
}

my @query-occupancy = <select NODE_NAME, sum ( REPORTING_MB ) / 1024 as GB from OCCUPANCY where STGPOOL_NAME in ( select STGPOOL_NAME from STGPOOLS where POOLTYPE='PRIMARY' ) group by NODE_NAME>;
my @query-contacts  = <select NODE_NAME, CONTACT from NODES>;
my @query-bucg      = <select trim(char(DOMAIN_NAME))||':'||trim(char(CLASS_NAME)) as "DOMAIN_CLASS",RETEXTRA from BU_COPYGROUPS where SET_NAME='ACTIVE'>;

sub byGB (Spreadsheet::XLSX:D $workbook) {

################################################################################
###     Gather data from all sources                                         ###
################################################################################

    my %data;
    my %BU2GB;
    my %NODE2GB;
    my %BUCG2RET;

    for @isp-servers -> $isp-server {
        my $dsmadmc     = ISP::dsmadmc.new(:$isp-admin, :$isp-server);
        my @occupancy   = $dsmadmc.execute(@query-occupancy);
        for @occupancy -> $rcd {
            next unless $rcd<NODE_NAME>;
            if $isp-server eq 'ISPLC02' {
                next unless %ISPLC02-inc{$rcd<NODE_NAME>}:exists;
            }
            if $isp-server eq 'JATSMPRD02' {
                next unless %JATSMPRD02-inc{$rcd<NODE_NAME>}:exists;
            }
            if $isp-server eq 'P520TSMJGB' {
                next unless %P520TSMJGB-inc{$rcd<NODE_NAME>}:exists;
            }
            if $isp-server eq 'CATSMDEV01' {
                next unless %CATSMDEV01-inc{$rcd<NODE_NAME>}:exists;
            }
            %data{$isp-server}{$rcd<NODE_NAME>}<GB> = $rcd<GB>;
            %NODE2GB{$rcd<NODE_NAME>} += $rcd<GB>;
        }
        my @contacts    = $dsmadmc.execute(@query-contacts);
        for @contacts -> $rcd {
            if $isp-server eq 'ISPLC02' {
                next unless %ISPLC02-inc{$rcd<NODE_NAME>}:exists;
            }
            if $isp-server eq 'JATSMPRD02' {
                next unless %JATSMPRD02-inc{$rcd<NODE_NAME>}:exists;
            }
            if $isp-server eq 'P520TSMJGB' {
                next unless %P520TSMJGB-inc{$rcd<NODE_NAME>}:exists;
            }
            if $isp-server eq 'CATSMDEV01' {
                next unless %CATSMDEV01-inc{$rcd<NODE_NAME>}:exists;
            }
            %data{$isp-server}{$rcd<NODE_NAME>}<BU> = $rcd<CONTACT>.subst(/^.*';'/);
        }
        my @bucg        = $dsmadmc.execute(@query-bucg);
ddt @bucg;
die;
        for @bucg -> $rcd {
            if $isp-server eq 'ISPLC02' {
                next unless %ISPLC02-inc{$rcd<NODE_NAME>}:exists;
            }
            if $isp-server eq 'JATSMPRD02' {
                next unless %JATSMPRD02-inc{$rcd<NODE_NAME>}:exists;
            }
            if $isp-server eq 'P520TSMJGB' {
                next unless %P520TSMJGB-inc{$rcd<NODE_NAME>}:exists;
            }
            if $isp-server eq 'CATSMDEV01' {
                next unless %CATSMDEV01-inc{$rcd<NODE_NAME>}:exists;
            }
#           %BUCG2RET
        }
    }

################################################################################
###     Output Excel                                                         ###
################################################################################

    for %data.keys.sort -> $isp-server {
        for %data{$isp-server}.keys.sort -> $node-name {
            next unless %data{$isp-server}{$node-name}<BU> && %data{$isp-server}{$node-name}<GB>;
            %BU2GB{%data{$isp-server}{$node-name}<BU>} += %data{$isp-server}{$node-name}<GB>;
        }
    }
    my @bu2gb                       = %BU2GB.keys.sort;
    my @node2gb                     = %NODE2GB.keys.sort;

    my $sheet;
    $sheet                          = $workbook.create-worksheet('By NODE');
    $sheet.cells[0;0]               = Spreadsheet::XLSX::Cell::Text.new(value => 'NODE');
    $sheet.cells[0;0].style.bold    = True;
    $sheet.cells[0;1]               = Spreadsheet::XLSX::Cell::Text.new(value => 'GB');
    $sheet.cells[0;1].style.bold    = True;
    printf "%-20s%s\n", 'NODE', 'GB';
    loop (my $i = 0; $i < @node2gb.elems; $i++) {
        printf "%-20s%.2f\n", @node2gb[$i], +%NODE2GB{@node2gb[$i]};
        $sheet.cells[$i+1;0]        = Spreadsheet::XLSX::Cell::Text.new(value => @node2gb[$i]);
        $sheet.cells[$i+1;1]        = Spreadsheet::XLSX::Cell::Text.new(value => %NODE2GB{@node2gb[$i]}.Str);
#       $sheet.cells[$i+1;1].style.number-format = '#,###';
    }

    $sheet                          = $workbook.create-worksheet('By BU');
    $sheet.cells[0;0]               = Spreadsheet::XLSX::Cell::Text.new(value => 'BUSINESS UNIT');
    $sheet.cells[0;0].style.bold    = True;
    $sheet.cells[0;1]               = Spreadsheet::XLSX::Cell::Text.new(value => 'GB');
    $sheet.cells[0;1].style.bold    = True;
    printf "%-20s%s\n", 'BUSINESS UNIT', 'GB';
    loop ($i = 0; $i < @bu2gb.elems; $i++) {
        printf "%-20s%.2f\n", @bu2gb[$i], +%BU2GB{@bu2gb[$i]};
        $sheet.cells[$i+1;0]        = Spreadsheet::XLSX::Cell::Text.new(value => @bu2gb[$i]);
        $sheet.cells[$i+1;1]        = Spreadsheet::XLSX::Cell::Text.new(value => %BU2GB{@bu2gb[$i]}.Str);
#       $sheet.cells[$i+1;1].style.number-format = '#,###';
    }
}

sub MAIN (
#   Str:D   :$isp-server,                           #= ISP server name
#   Str:D   :$isp-admin,                            #= ISP server admin
) {
    my $workbook    = Spreadsheet::XLSX.new;
    byGB($workbook);
    $workbook.save($outfile);
}

=finish
